<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  let deliveryDate = "";
  let pickupDate = "";

  const DEBUG_MODE = false;

  function showStatus(message, type = 'error') {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.textContent = message;
    statusDiv.className = `status-message status-${type}`;
    statusDiv.style.display = 'block';

    if (type === 'success') {
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }
  }

  function debugLog(message, data = null) {
    if (DEBUG_MODE) {
      console.log(message, data);
    }
  }

  flatpickr("#dateRangePicker", {
    mode: "range",
    inline: true,
    minDate: "today",
    dateFormat: "Y-m-d",
    onChange: function(selectedDates) {
      if (selectedDates.length === 2) {
        deliveryDate = selectedDates[0].toISOString().split('T')[0];
        pickupDate = selectedDates[1].toISOString().split('T')[0];
      }
    }
  });

  const form = document.getElementById('bookingForm');
  const submitBtn = document.getElementById('submitBtn');

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const time = document.getElementById('timeSlot').value;

    if (!name || !email || !deliveryDate || !pickupDate || !time) {
      showStatus("Please complete all fields.");
      resetSubmitButton();
      return;
    }

    const data = { name, email, delivery_date: deliveryDate, pickup_date: pickupDate, time };
    const scriptUrl = "https://script.google.com/macros/s/AKfycbxW1AA24avTntdHQzVA-YunXuljAzv93bZTJHDKc-eR7IUoFWJ2Ui7DvdGFH9A_gS9CAQ/exec";

    fetch(scriptUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(responseData => {
      debugLog("Response:", responseData);

      if (responseData.status === "conflict") {
        showStatus("That time slot is already booked. Please choose another.");
        resetSubmitButton();
      } else if (responseData.status === "booked") {
        showStatus("Booking submitted! Redirecting to payment...", 'success');
        setTimeout(() => {
          window.location.href = "https://square.link/u/hjhYelu2";
        }, 2000);
      } else {
        showStatus("Something went wrong. Please try again.");
        resetSubmitButton();
      }
    })
    .catch(error => {
      console.error("Error:", error);
      showStatus("Submission failed. Please try again later.");
      resetSubmitButton();
    });
  });

  function resetSubmitButton() {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit and Confirm';
  }
</script>
